namespace Biblioteca{

class RepositorioClienteArchTexto:IRepositorioCliente{


    public void AgregarCliente(Cliente cliente){
            using (StreamWriter sw = new StreamWriter("Clientes.txt")){
                sw.WriteLine($"{cliente.documento}{cliente.nombre}{cliente.apellido}{cliente.direccion}{cliente.fecha_nacimiento}{cliente.fecha_compra}");
                
            }          
    }
    public List<Cliente>GetClientes(){
        List<Cliente>lista = new List<Cliente>();
        StreamReader sr = new StreamReader("Clientes.txt");
        Cliente cliente = new Cliente();
        string? linea;
        string[] campos = new string[5];
        while(!sr.EndOfStream){
            linea = sr.ReadLine();
            while(linea != null){
                campos = linea.Split('|');
            }  
            cliente.documento=Int32.Parse(campos[0]);
            cliente.nombre=campos[1];
            cliente.apellido=campos[2];
            cliente.direccion=campos[3];
            cliente.fecha_nacimiento=DateTime.Parse(campos[4]);
            cliente.fecha_compra=DateTime.Parse(campos[5]);
            lista.Add(cliente);
        
        }
        sr.Close();
        return lista;
    }

    public Cliente? GetCliente(int DNI){
        StreamReader sr = new StreamReader("Clientes.txt");
        Cliente cliente = new Cliente();
        string? linea;
        string[] campos = new string[5];
        bool ok=true;
        while((!sr.EndOfStream)&&(ok==true)){
                linea = sr.ReadLine();
                while(linea != null){
                    campos = linea.Split('|');
                }
                if(Int32.Parse(campos[0]) == DNI){
                    cliente.documento=Int32.Parse(campos[0]);
                    cliente.nombre=campos[1];
                    cliente.apellido=campos[2];
                    cliente.direccion=campos[3];
                    cliente.fecha_nacimiento=DateTime.Parse(campos[4]);
                    cliente.fecha_compra=DateTime.Parse(campos[5]);
                    ok=false;
                }          
        }  
        sr.Close();  
        if(ok==true){
            return null;
        }
        else{
            return cliente;
        }
    }

    public void ModificarCliente(Cliente cliente){
        using (StreamReader sr = new StreamReader("Cliente.txt")){
        while(!sr.EndOfStream){
            string? cadena = sr.ReadLine();
            string[] elementos = new string [6];
            while(cadena != null){
                elementos = cadena.Split("|");
            } 
            if(cliente.documento == Int32.Parse(elementos[0])){
                using(StreamWriter sw = new StreamWriter("Cliente.txt")){
                        sw.WriteLine($"{cliente.documento}|{cliente.nombre}|{cliente.apellido}|{cliente.direccion}|{cliente.fecha_nacimiento}|{cliente.fecha_compra}|");
                }
            }
        }

        }
    }

    public void EliminarCliente(int Dni){
        StreamWriter sw = File.CreateText("temporal.txt");
        StreamReader sr = new StreamReader("Clientes.txt");
        string? linea;
        string[] campos = new string[5];
        bool ok=false;
        while(!sr.EndOfStream){
            linea = sr.ReadLine();
            while(linea != null){
                campos = linea.Split('|');
            }
            for(int i=0;i < campos.Length;i++){
                if(Int32.Parse(campos[0]) == Dni){
                    ok=true;; 
                }
                else{
                    sw.WriteLine(linea);
                }
            }
        }
        if(ok == false){
            Console.WriteLine("El dni no esta en el archivo");
        }
        sw.Close();
        sr.Close();
        File.Delete("Clientes.txt");
        File.Move("temporal.txt","Clientes.txt");
        
    }
    }

}
